name: trinocular

networks:
  trinocular_network:
    driver: bridge

volumes:
  postgres_data:
    driver: local
  nginx_cache:
    driver: local

services:
  postgres:
    image: postgres:17.0-alpine3.20
    volumes:
      - postgres_data:/var/lib/postgresql/data
    env_file: "src/postgres/.env"
    secrets:
      - postgres_secret
    networks:
      - trinocular_network


  keycloak:
    image: quay.io/keycloak/keycloak:26.0.0
    env_file: "src/keycloak/.env"
    entrypoint: 
      - /bin/bash 
      - -c 
      - |
        export KC_DB_PASSWORD=$$(cat /run/secrets/postgres_secret)
        export KEYCLOAK_ADMIN_PASSWORD=$$(cat /run/secrets/keycloak_admin_secret)
        exec /opt/keycloak/bin/kc.sh start-dev
    secrets:
      - postgres_secret
      - keycloak_admin_secret
    networks:
      - trinocular_network
    ports:
      - 9000:8080
    restart: always
    depends_on:
      - postgres

  memcached:
    image: memcached:1.6.31-alpine3.20
    container_name: memcached
    networks:
      - trinocular_network
    ports:
        - 11211:11211
    healthcheck:
        test: echo "version" | nc -vn -w 1 127.0.0.1 11211
        interval: 5s
        timeout: 5s
        retries: 5

  nginx:
    image: trinocular-nginx-service
    build:
        context: ./
        dockerfile: ./src/nginx/Dockerfile
    volumes:
      - nginx_cache:/var/cache/nginx
    tmpfs:
      - /run
    networks:
      - trinocular_network
    ports:
      - 8080:8080

  auth:
    image: trinocular-auth-service
    build:
      context: ./
      dockerfile: ./src/auth/Dockerfile
    env_file: "src/auth/.env"
    environment:
      - NODE_ENV=production
    secrets:
      - auth_client_secret
      - session_secret
    networks:
      - trinocular_network
    ports:
      - 8081:80
    healthcheck:
      test: wget --no-verbose --tries=1 --spider  http://auth/ || exit 1
      interval: 5s
      timeout: 5s
      retries: 5
    depends_on:
      - memcached

  frontend:
    image: trinocular-frontend-service
    build:
      context: ./
      dockerfile: ./src/frontend/Dockerfile
    env_file: "src/frontend/.env"
    environment:
      - NODE_ENV=production
    secrets:
      - session_secret
      - internal_api_secret
    networks:
      - trinocular_network
    ports:
      - 8082:80
    healthcheck:
      test: wget --no-verbose --tries=1 --spider  http://frontend/ || exit 1
      interval: 5s
      timeout: 5s
      retries: 5
    depends_on:
      - memcached
      - registry


  registry:
    image: trinocular-registry-service
    build:
      context: ./
      dockerfile: ./src/registry/Dockerfile
    env_file: "src/registry/.env"
    environment:
      - NODE_ENV=production
    secrets:
      - internal_api_secret
    networks:
      - trinocular_network
    ports:
      - 8083:80
    healthcheck:
      test: wget --no-verbose --tries=1 --spider  http://registry/ || exit 1
      interval: 5s
      timeout: 5s
      retries: 5


secrets:
  session_secret:
    file: ./secrets/session.txt
  internal_api_secret:
    file: ./secrets/internal_api.txt
  postgres_secret:
    file: ./secrets/postgres.txt
  auth_client_secret:
    file: ./secrets/auth_client.txt
  keycloak_admin_secret:
    file: ./secrets/keycloak_admin_secret.txt
  